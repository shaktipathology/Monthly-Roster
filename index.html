<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department of Pathology and Lab Medicine - AIIMS Bhopal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Times+New+Roman&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            background-color: #f0f0f0; /* A light grey background to make the "page" stand out */
            color: #000000;
        }
        .printable-container {
            max-width: 210mm; /* A4 width */
            min-height: 297mm; /* A4 height */
            margin: 1cm auto; /* Reduced margins */
            padding: 1.5cm;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            border: 1px solid #ccc;
        }
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }
        th, td {
            padding: 5px; /* Further reduced padding */
            text-align: left;
            font-size: 9pt; /* Further reduced font size */
            vertical-align: top; /* Align content to the top of the cell */
            word-break: break-word; /* Prevents text from overflowing its cell */
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        /* Intelligent Column Widths for 7 columns*/
        .col-date { width: 9%; }
        .col-day { width: 9%; }
        .col-time { width: 12%; }
        .col-tlm { width: 6%; }
        .col-venue { width: 14%; }
        .col-topic { width: 30%; }
        .col-faculty { width: 20%; }

        .header-title {
            font-size: 16pt;
            font-weight: bold;
        }
        .header-subtitle {
            font-size: 14pt;
            font-weight: bold;
        }
        .header-date {
            font-size: 12pt;
        }
        .notes-section {
             /* Ensures notes start on a new page when printing if necessary */
             page-break-before: always;
        }
        .topic-content, .faculty-content {
            white-space: pre-wrap; /* Allows text to wrap and preserves line breaks */
        }
        .faculty-content i {
            color: #333; /* Slightly lighter text for SR/JR names */
        }
        @media print {
            body, .printable-container {
                margin: 0;
                padding: 1cm;
                box-shadow: none;
                border: none;
                background-color: #fff;
            }
            .controls {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="printable-container">
        
        <!-- Header Section -->
        <header class="text-center mb-6">
            <h1 class="header-title">Department of Pathology and Lab Medicine</h1>
            <h2 class="header-subtitle">All India Institute of Medical Sciences, Bhopal</h2>
            <p id="current-date" class="header-date mt-2"></p>
        </header>

        <!-- Controls for Month Selection -->
        <div class="controls mb-4 flex items-center space-x-4">
            <label for="month-filter" class="font-bold text-base">Select Month:</label>
            <select id="month-filter" class="p-2 border border-black rounded-none text-base"></select>
        </div>

        <!-- Main Content: Schedule Table -->
        <main>
            <h3 class="text-lg font-bold mb-2 text-center">MBBS 2024 3rd SEM Master Roster</h3>
            <div id="loader" class="text-center p-16">
                <p>Loading schedule...</p>
            </div>
            <div class="overflow-x-auto">
                <table id="schedule-table" class="w-full hidden" style="table-layout: fixed;">
                    <thead>
                        <tr>
                            <th class="col-date">Date</th>
                            <th class="col-day">Day</th>
                            <th class="col-time">Time (AM/PM)</th>
                            <th class="col-tlm">TLM</th>
                            <th class="col-venue">Venue</th>
                            <th class="col-topic">Topic</th>
                            <th class="col-faculty">Faculty / SR-JR</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </main>

        <!-- Notes Section -->
        <section class="notes-section mt-8">
            <h3 class="text-lg font-bold mb-2 border-b border-black pb-1">Notes & Updates</h3>
            <div id="notes-loader" class="text-center p-8">
                <p>Loading notes...</p>
            </div>
            <div id="notes-content" class="text-sm">
                <!-- Content from Google Doc will be inserted here -->
            </div>
        </section>

        <!-- Footer Section -->
        <footer class="text-center mt-12 pt-6 border-t border-black text-sm">
            <div class="flex justify-around">
                <div>
                    <p class="font-bold">Dr. Shakti Kumar Yadav</p>
                    <p>Associate Professor</p>
                </div>
                <div>
                    <p class="font-bold">Prof. Dr. Deepti Joshi</p>
                    <p>Professor</p>
                </div>
                <div>
                    <p class="font-bold">Prof. Dr. Vaishali Walke</p>
                    <p>Head of the Department</p>
                </div>
            </div>
        </footer>

    </div>

    <script>
        // URLs for the public Google Sheet (as CSV) and Google Doc (as published HTML)
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRO72s6aR0pRLGcn8uyS-Do5BJ-G3VCFg1pbRJS-QS4j8qYmNK5aj8J2JWhu6BdGLUOrq6wvSrBA4Jy/pub?gid=0&single=true&output=csv';
        const DOC_URL = 'https://docs.google.com/document/d/e/2PACX-1vSu1rPSbN9SWDSwNa4Xlwbb9o7n5RRQyhLr7HEKe4tKuaUSknfsvIYeXFFEvZcKZFr3uLl8b7KBcwLO/pub';

        let fullScheduleData = []; // To store all fetched data

        // Set the current date in the header
        function displayCurrentDate() {
            const dateElement = document.getElementById('current-date');
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateElement.textContent = today.toLocaleDateString('en-US', options);
        }

        /**
         * A robust CSV parser that correctly handles quoted fields, including newlines and escaped quotes.
         * @param {string} csvText The raw CSV string.
         * @returns {Array<Object>} An array of objects representing the CSV data.
         */
        function parseCSV(csvText) {
            const result = [];
            let headers = [];
            let inQuotes = false;
            let currentCell = '';
            let currentRow = [];
            
            const text = csvText.trim().replace(/\r\n/g, '\n');

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        currentCell += '"';
                        i++; // Skip the next quote
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        currentCell += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        currentRow.push(currentCell);
                        currentCell = '';
                    } else if (char === '\n') {
                        currentRow.push(currentCell);
                        currentCell = '';
                        if (headers.length === 0) {
                            headers = currentRow.map(h => h.trim());
                        } else {
                            const entry = {};
                            headers.forEach((header, index) => {
                                entry[header] = currentRow[index] || '';
                            });
                            result.push(entry);
                        }
                        currentRow = [];
                    } else {
                        currentCell += char;
                    }
                }
            }
            if (currentRow.length > 0 || currentCell) {
                 currentRow.push(currentCell);
                 const entry = {};
                 headers.forEach((header, index) => {
                     entry[header] = currentRow[index] || '';
                 });
                 result.push(entry);
            }
            return result;
        }

        // Function to process raw data, merging continuation rows
        function processScheduleData(rawData) {
            const processedData = [];
            let lastMasterRow = null;

            rawData.forEach(row => {
                if (Object.values(row).every(val => val.trim() === '')) {
                    return;
                }
                if (row['Date'] && row['Date'].trim() !== '') {
                    processedData.push(row);
                    lastMasterRow = row;
                } else if (lastMasterRow) {
                    for (const key in row) {
                        if (row[key] && row[key].trim() !== '') {
                            if (lastMasterRow[key] && lastMasterRow[key].trim() !== '') {
                                lastMasterRow[key] += `\n${row[key].trim()}`;
                            } else {
                                lastMasterRow[key] = row[key].trim();
                            }
                        }
                    }
                }
            });
            return processedData;
        }

        // Function to format time from HH:mm to AM/PM
        function formatTime(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return '';
            let [hours, minutes] = timeStr.split(':');
            let H = parseInt(hours, 10);
            let M = parseInt(minutes, 10);
            if (isNaN(H) || isNaN(M)) return '';
            let ampm = H >= 12 ? 'PM' : 'AM';
            H = H % 12;
            H = H ? H : 12;
            let minutesStr = M < 10 ? '0' + M : M;
            return `${H}:${minutesStr} ${ampm}`;
        }

        // Function to populate the month filter dropdown
        function populateMonthFilter(data) {
            const monthFilter = document.getElementById('month-filter');
            const months = new Set();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            data.forEach(row => {
                if (row['Date'] && row['Date'].includes('/')) {
                    const parts = row['Date'].split('/');
                    if (parts.length === 3) {
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        if (!isNaN(month) && !isNaN(year) && month >=0 && month < 12) {
                           months.add(JSON.stringify({year: year, month: month}));
                        }
                    }
                }
            });

            monthFilter.innerHTML = '';
            const sortedMonths = Array.from(months)
                .map(item => JSON.parse(item))
                .sort((a, b) => a.year - b.year || a.month - b.month);

            sortedMonths.forEach(date => {
                const option = document.createElement('option');
                const monthYearStr = `${monthNames[date.month]} ${date.year}`;
                option.value = monthYearStr;
                option.textContent = monthYearStr;
                monthFilter.appendChild(option);
            });
            
            const today = new Date();
            const currentMonthStr = `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
            if (sortedMonths.some(d => `${monthNames[d.month]} ${d.year}` === currentMonthStr)) {
                monthFilter.value = currentMonthStr;
            }

            monthFilter.addEventListener('change', () => renderTable());
        }

        // Function to render the table based on the selected month
        function renderTable() {
            const tableBody = document.getElementById('schedule-table').querySelector('tbody');
            const loader = document.getElementById('loader');
            const selectedMonth = document.getElementById('month-filter').value;
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            const filteredData = fullScheduleData.filter(row => {
                if (!row['Date'] || !row['Date'].includes('/')) return false;
                const parts = row['Date'].split('/');
                if (parts.length !== 3) return false;
                const month = parseInt(parts[1], 10) - 1;
                const year = parseInt(parts[2], 10);
                if (isNaN(month) || isNaN(year)) return false;
                const rowMonthStr = `${monthNames[month]} ${year}`;
                return rowMonthStr === selectedMonth;
            });

            tableBody.innerHTML = ''; 

            if (filteredData.length > 0) {
                filteredData.forEach(row => {
                    const tr = document.createElement('tr');
                    const startTime = formatTime(row['Start time']);
                    const endTime = formatTime(row['End Time']);
                    const timeRange = (startTime && endTime) ? `${startTime} to ${endTime}` : '';
                    
                    const facultyNames = [row['Faculty 1 Name'], row['Faculty 2 Name'], row['Faculty 3 Name']].filter(Boolean).join(', ');
                    const residentNames = [row['SR Name'], row['JR Name']].filter(Boolean).join(', ');
                    
                    let combinedNames = facultyNames;
                    if (residentNames) {
                        combinedNames += `${facultyNames ? '\n' : ''}<i>(SR/JR: ${residentNames})</i>`;
                    }

                    tr.innerHTML = `
                        <td>${row['Date'] || ''}</td>
                        <td>${row['Day'] || ''}</td>
                        <td>${timeRange}</td>
                        <td>${row['TLM'] || ''}</td>
                        <td>${row['Venue'] || ''}</td>
                        <td><div class="topic-content">${row['Topic'] || ''}</div></td>
                        <td><div class="faculty-content">${combinedNames || ''}</div></td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                 tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No schedule found for the selected month.</td></tr>';
            }

            document.getElementById('schedule-table').classList.remove('hidden');
            loader.style.display = 'none';
        }

        // Main function to fetch and initialize data
        async function loadSchedule() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();
                const rawData = parseCSV(csvText);
                fullScheduleData = processScheduleData(rawData);
                
                populateMonthFilter(fullScheduleData);
                renderTable();

            } catch (error) {
                console.error('Failed to load schedule:', error);
                document.getElementById('loader').innerHTML = '<p style="color: red;">Failed to load schedule data. Please check the sheet link and format.</p>';
            }
        }
        
        // Function to fetch and display notes from Google Doc
        async function loadNotes() {
            const notesContent = document.getElementById('notes-content');
            const notesLoader = document.getElementById('notes-loader');
            try {
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const response = await fetch(proxyUrl + encodeURIComponent(DOC_URL));
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const docHtml = data.contents;

                const parser = new DOMParser();
                const doc = parser.parseFromString(docHtml, 'text/html');
                notesContent.innerHTML = doc.body.innerHTML;
                
                notesContent.querySelectorAll('style').forEach(style => style.remove());
                notesContent.querySelectorAll('[style]').forEach(el => el.removeAttribute('style'));

            } catch (error) {
                console.error('Failed to load notes:', error);
                notesContent.innerHTML = '<p style="color: red;">Failed to load notes.</p>';
            } finally {
                notesLoader.style.display = 'none';
            }
        }

        // Initial load when the page content is ready
        document.addEventListener('DOMContentLoaded', () => {
            displayCurrentDate();
            loadSchedule();
            loadNotes();
        });
    </script>

</body>
</html>
